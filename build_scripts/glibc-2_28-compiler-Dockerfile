ARG ARCHITECTURE="x86_64"
FROM quay.io/pypa/manylinux_2_28_${ARCHITECTURE}:latest

WORKDIR /src

# Install libraries
RUN yum -y update \
&& yum -y install \
    gcc \
    make \
    git \
    curl \
    patchelf \
    perl-core \
    zlib-devel bzip2-devel xz-devel libffi-devel \
    ca-certificates tar gzip \
&& update-ca-trust \
&& yum -y clean all \
&& rm -rf /var/cache/yum

# Build openssl from source
ARG OPENSSL_VERSION="1.1.1w"
RUN curl -fsSLO "https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz" \
 && tar -xzf "openssl-${OPENSSL_VERSION}.tar.gz" \
 && cd "openssl-${OPENSSL_VERSION}" \
 && ./config --prefix=/opt/openssl --openssldir=/opt/openssl shared zlib \
 && make -j"$(nproc)" \
 && make install_sw \
 && cd /src \
 && rm -rf "openssl-${OPENSSL_VERSION}"*

# Set OpenSSL environment variables
ENV OPENSSL_ROOT=/opt/openssl
ENV PATH="${OPENSSL_ROOT}/bin:${PATH}"

# Build Python from source
ARG PYTHON_VERSION="3.13.11"
RUN curl -fsSLO "https://www.python.org/ftp/python/${PYTHON_VERSION}/Python-${PYTHON_VERSION}.tgz" \
&& tar -xzf "Python-${PYTHON_VERSION}.tgz" \
&& cd "Python-${PYTHON_VERSION}" \
&& export CPPFLAGS="-I${OPENSSL_ROOT}/include" \
&& export LDFLAGS="-L${OPENSSL_ROOT}/lib -Wl,-rpath,${OPENSSL_ROOT}/lib" \
&& ./configure \
    --prefix=/opt/python-${PYTHON_VERSION} \
    --disable-shared \
    --with-ensurepip=install \
    --with-openssl=${OPENSSL_ROOT} \
    --with-openssl-rpath=auto \
&& make -j"$(nproc)" \
&& make install \
&& cd /src \
&& rm -rf "Python-${PYTHON_VERSION}"*

ENV PYTHON_PATH=/opt/python-${PYTHON_VERSION}/bin/python3

# Verify SSL support
RUN ${PYTHON_PATH} -c "import ssl; print('ssl:', ssl.OPENSSL_VERSION)"

# Copy project files
COPY README.md pyproject.toml setup.py /src/
COPY where_my_tunnels /src/where_my_tunnels

# Install python modules
RUN ${PYTHON_PATH} -m pip install --upgrade pip setuptools wheel \
&& ${PYTHON_PATH} -m pip install .[dev]

# Compile with Nuitka
RUN ${PYTHON_PATH} -m nuitka \
    --onefile \
    --static-libpython=yes \
    --follow-imports \
    --lto=yes \
    --output-filename=/src/wheremytunnels.bin \
    /src/where_my_tunnels/main.py

CMD ["/src/wheremytunnels.bin", "--version"]